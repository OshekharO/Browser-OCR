<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Browser OCR</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
      body {
        background: #f8fafc;
        color: #0f172a;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      }
      .app-header {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: #fff;
        padding: 2.5rem 1rem;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.04);
      }
      .upload-box {
        background: #f1f5f9;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
      }
      .preview-thumb {
        max-height: 120px;
        max-width: 180px;
        object-fit: contain;
      }
      textarea {
        resize: none;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }
      footer {
        border-top: 1px solid #e5e7eb;
        color: #64748b;
        font-size: 0.875rem;
      }
    </style>
  </head>

  <body>
    <header class="app-header text-center">
      <div class="container">
        <h1 class="display-6 mb-2">Browser OCR</h1>
        <p class="lead mb-0">Private, client-side text extraction</p>
      </div>
    </header>

    <main class="container py-5">
      <div class="row g-4">
        <!-- INPUT -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="mb-3">1. Upload & Configure</h5>

              <label class="fw-semibold">Images or PDFs</label>
              <input id="fileInput" type="file" class="form-control" accept="image/*,.pdf" multiple />

              <label class="fw-semibold mt-3">OCR Language</label>
              <select id="languageSelect" class="form-select">
                <option value="eng">English</option>
                <option value="hin">Hindi</option>
                <option value="fra">French</option>
                <option value="spa">Spanish</option>
                <option value="deu">German</option>
                <option value="chi_sim">Chinese</option>
              </select>

              <label class="fw-semibold mt-3">OCR Preset</label>
              <select id="presetSelect" class="form-select">
                <option value="scan">üìÑ Scanned document</option>
                <option value="screenshot">üñ• Screenshot / UI</option>
                <option value="notes">üìù Notes / handwriting</option>
                <option value="photo">üì∏ Camera photo</option>
              </select>

              <div class="upload-box mt-4 text-center">
                <p class="text-muted mb-2">File preview</p>
                <div id="previewList" class="d-flex flex-wrap gap-2 justify-content-center"></div>
              </div>

              <details class="mt-3">
                <summary class="fw-semibold">Advanced</summary>
                <div class="form-check mt-2">
                  <input id="downscaleToggle" class="form-check-input" type="checkbox" checked />
                  <label class="form-check-label"> Enable smart image downscaling (recommended) </label>
                </div>
              </details>

              <div class="d-flex gap-2 mt-4">
                <button id="extractBtn" class="btn btn-primary w-100" disabled>
                  <span id="spinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                  Extract Text
                </button>
                <button id="cancelBtn" class="btn btn-outline-danger d-none">Cancel</button>
              </div>

              <div class="progress mt-3 d-none" style="height: 6px">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"></div>
              </div>

              <div
                id="statusText"
                class="small mt-2"
                role="status"
                aria-live="polite"
                aria-atomic="true"
              ></div>
            </div>
          </div>
        </div>

        <!-- OUTPUT -->
        <div class="col-lg-7">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="mb-3">2. Extracted Text</h5>

              <textarea
                id="resultText"
                class="form-control flex-grow-1 mb-3"
                rows="10"
                placeholder="OCR result will appear here‚Ä¶"
                readonly
              ></textarea>

              <div class="d-flex gap-2">
                <button id="copyBtn" class="btn btn-outline-primary" disabled>Copy</button>
                <button id="downloadBtn" class="btn btn-outline-success" disabled>Download</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="py-4">
      <div class="container d-flex flex-column flex-md-row justify-content-between text-center text-md-start gap-2">
        <div>
          <strong>Browser OCR</strong>
          <div>All processing happens in your browser.</div>
        </div>
        <div>Powered by Tesseract.js ¬∑ No uploads ¬∑ No tracking</div>
      </div>
    </footer>

    <!-- PDF.js (STABLE UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    </script>

    <!-- Tesseract -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@7.0.0/dist/tesseract.min.js"></script>

    <script>
      /* ===================== STATE ===================== */
      let cancelRequested = false;
      let previewURLs = [];

      /* ===================== DOM ===================== */
      const fileInput = document.getElementById("fileInput");
      const previewList = document.getElementById("previewList");
      const extractBtn = document.getElementById("extractBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const spinner = document.getElementById("spinner");
      const statusText = document.getElementById("statusText");
      const resultText = document.getElementById("resultText");
      const progressBar = document.getElementById("progressBar");
      const progressWrap = progressBar.parentElement;
      const languageSel = document.getElementById("languageSelect");
      const presetSel = document.getElementById("presetSelect");
      const downscaleToggle = document.getElementById("downscaleToggle");
      const copyBtn = document.getElementById("copyBtn");
      const downloadBtn = document.getElementById("downloadBtn");

      const PRESET_STATUS = {
        scan: "Deskewing ‚Üí Enhancing contrast ‚Üí Recognizing text",
        screenshot: "Optimizing UI text ‚Üí Recognizing",
        notes: "Enhancing handwriting ‚Üí Recognizing",
        photo: "Normalizing photo ‚Üí Recognizing",
      };

      /* ===================== HELPERS ===================== */
      async function downscaleImage(file, maxWidth = 1600) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        if (img.naturalWidth <= maxWidth) {
          URL.revokeObjectURL(img.src);
          return file;
        }

        const scale = maxWidth / img.naturalWidth;
        const canvas = document.createElement("canvas");
        canvas.width = maxWidth;
        canvas.height = img.naturalHeight * scale;
        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

        URL.revokeObjectURL(img.src);
        return new Promise((res) => canvas.toBlob((b) => res(b), "image/jpeg", 0.9));
      }

      async function extractTextFromPdf(pdf) {
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map((it) => it.str).join(" ") + "\n";
        }
        return text.trim();
      }

      async function renderPdfPageToImage(pdf, pageNum) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
        return new Promise((res) => canvas.toBlob((b) => res(b), "image/png"));
      }

      /* ===================== PREVIEW ===================== */
      fileInput.onchange = (e) => {
        previewURLs.forEach(URL.revokeObjectURL);
        previewURLs = [];
        previewList.innerHTML = "";

        [...e.target.files].forEach((f) => {
          if (f.type.startsWith("image/")) {
            const url = URL.createObjectURL(f);
            previewURLs.push(url);
            const img = document.createElement("img");
            img.src = url;
            img.className = "preview-thumb rounded";
            previewList.appendChild(img);
          } else {
            const badge = document.createElement("div");
            badge.className = "badge bg-secondary";
            badge.textContent = "PDF";
            previewList.appendChild(badge);
          }
        });

        extractBtn.disabled = false;
      };

      /* ===================== OCR ===================== */
      extractBtn.onclick = async () => {
        const files = [...fileInput.files];
        if (!files.length) return;

        cancelRequested = false;
        extractBtn.disabled = true;
        cancelBtn.classList.remove("d-none");
        spinner.classList.remove("d-none");
        progressWrap.classList.remove("d-none");
        progressBar.style.width = "0%";
        statusText.setAttribute("aria-busy", "true");
        statusText.textContent = "Preparing OCR‚Ä¶";

        let totalSteps = 0;
        for (const f of files) {
          if (f.type === "application/pdf") {
            const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
            totalSteps += pdf.numPages;
          } else {
            totalSteps++;
          }
        }

        let completed = 0;
        const startTime = Date.now();
        let output = "";

        for (const file of files) {
          if (cancelRequested) break;

          if (file.type === "application/pdf") {
            statusText.textContent = "Analyzing PDF‚Ä¶";
            const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
            const text = await extractTextFromPdf(pdf);

            if (text.length > 50) {
              output += text + "\n\n";
              completed += pdf.numPages;
              progressBar.style.width = `${(completed / totalSteps) * 100}%`;
              continue;
            }

            for (let p = 1; p <= pdf.numPages; p++) {
              if (cancelRequested) break;

              const elapsed = (Date.now() - startTime) / 1000;
              const overall = (completed / totalSteps) * 100;
              const remaining = elapsed * ((100 - overall) / Math.max(overall, 1));

              statusText.textContent =
                `${PRESET_STATUS[presetSel.value]} ¬∑ PDF page ${p}/${pdf.numPages} ¬∑ ~${Math.ceil(remaining)}s left`;

              const img = await renderPdfPageToImage(pdf, p);
              const res = await Tesseract.recognize(img, languageSel.value, {
                logger: (m) => {
                  if (m.progress != null) {
                    const prog = ((completed + m.progress) / totalSteps) * 100;
                    progressBar.style.width = `${Math.round(prog)}%`;
                  }
                },
              });

              output += res.data.text.trim() + "\n\n";
              completed++;
            }
            continue;
          }

          let input = downscaleToggle.checked ? await downscaleImage(file) : file;

          const elapsed = (Date.now() - startTime) / 1000;
          const overall = (completed / totalSteps) * 100;
          const remaining = elapsed * ((100 - overall) / Math.max(overall, 1));
          statusText.textContent =
            `${PRESET_STATUS[presetSel.value]} ¬∑ ~${Math.ceil(remaining)}s left`;

          const res = await Tesseract.recognize(input, languageSel.value, {
            logger: (m) => {
              if (m.progress != null) {
                const prog = ((completed + m.progress) / totalSteps) * 100;
                progressBar.style.width = `${Math.round(prog)}%`;
              }
            },
          });

          output += res.data.text.trim() + "\n\n";
          completed++;
        }

        previewURLs.forEach(URL.revokeObjectURL);
        previewURLs = [];
        previewList.innerHTML = "";

        spinner.classList.add("d-none");
        progressWrap.classList.add("d-none");
        cancelBtn.classList.add("d-none");
        extractBtn.disabled = false;
        statusText.removeAttribute("aria-busy");

        if (cancelRequested) {
          statusText.textContent = "OCR cancelled.";
        } else {
          resultText.value = output || "No text detected.";
          statusText.textContent = "OCR completed successfully.";
          copyBtn.disabled = !output;
          downloadBtn.disabled = !output;
        }
      };

      /* ===================== ACTIONS ===================== */
      cancelBtn.onclick = () => (cancelRequested = true);

      copyBtn.onclick = async () => {
        await navigator.clipboard.writeText(resultText.value);
        statusText.textContent = "Copied!";
      };

      downloadBtn.onclick = () => {
        const blob = new Blob([resultText.value], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "ocr.txt";
        a.click();
      };

      /* ===================== SHORTCUTS ===================== */
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !extractBtn.disabled) extractBtn.click();
        if (e.key === "Escape") cancelBtn.click();
        if ((e.ctrlKey || e.metaKey) && e.key === "c") {
          navigator.clipboard.writeText(resultText.value);
        }
      });
    </script>
  </body>
</html>
