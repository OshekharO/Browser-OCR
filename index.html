<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Browser OCR</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
      body {
        background: #f8fafc;
        color: #0f172a;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          sans-serif;
      }

      .app-header {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: #fff;
        padding: 2.5rem 1rem;
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.04);
      }

      .upload-box {
        background: #f1f5f9;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
      }

      .preview-thumb {
        max-height: 120px;
        max-width: 180px;
        object-fit: contain;
      }

      textarea {
        resize: none;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }

      footer {
        border-top: 1px solid #e5e7eb;
        color: #64748b;
        font-size: 0.875rem;
      }
    </style>
  </head>

  <body>
    <header class="app-header text-center">
      <div class="container">
        <h1 class="display-6 mb-2">Browser OCR</h1>
        <p class="lead mb-0">Private, client-side text extraction</p>
      </div>
    </header>

    <main class="container py-5">
      <div class="row g-4">
        <!-- INPUT -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="mb-3">1. Upload & Configure</h5>

              <label class="fw-semibold">Images</label>
              <input id="imageInput" type="file" class="form-control" accept="image/*" multiple />

              <label class="fw-semibold mt-3">OCR Language</label>
              <select id="languageSelect" class="form-select">
                <option value="eng">English</option>
                <option value="hin">Hindi</option>
                <option value="fra">French</option>
                <option value="spa">Spanish</option>
                <option value="deu">German</option>
                <option value="chi_sim">Chinese</option>
              </select>

              <label class="fw-semibold mt-3">OCR Preset</label>
              <select id="presetSelect" class="form-select">
                <option value="scan">üìÑ Scanned document</option>
                <option value="screenshot">üñ• Screenshot / UI</option>
                <option value="notes">üìù Notes / handwriting</option>
                <option value="photo">üì∏ Camera photo</option>
              </select>

              <div class="upload-box mt-4 text-center">
                <p class="text-muted mb-2">Image preview</p>
                <div id="previewList" class="d-flex flex-wrap gap-2 justify-content-center"></div>
              </div>

              <details class="mt-3">
                <summary class="fw-semibold">Advanced</summary>
                <div class="form-check mt-2">
                  <input id="downscaleToggle" class="form-check-input" type="checkbox" checked />
                  <label class="form-check-label"> Enable smart image downscaling (recommended) </label>
                </div>
              </details>

              <div class="d-flex gap-2 mt-4">
                <button id="extractBtn" class="btn btn-primary w-100" disabled>
                  <span id="spinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                  Extract Text
                </button>
                <button id="cancelBtn" class="btn btn-outline-danger d-none">Cancel</button>
              </div>

              <div class="progress mt-3 d-none" style="height: 6px">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"></div>
              </div>

              <div id="statusText" class="small mt-2" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>
          </div>
        </div>

        <!-- OUTPUT -->
        <div class="col-lg-7">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="mb-3">2. Extracted Text</h5>

              <textarea
                id="resultText"
                class="form-control flex-grow-1 mb-3"
                rows="10"
                placeholder="OCR result will appear here‚Ä¶"
                readonly
              ></textarea>

              <div class="d-flex gap-2">
                <button id="copyBtn" class="btn btn-outline-primary" disabled>Copy</button>
                <button id="downloadBtn" class="btn btn-outline-success" disabled>Download</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="py-4">
      <div class="container d-flex flex-column flex-md-row justify-content-between text-center text-md-start gap-2">
        <div>
          <strong>Browser OCR</strong>
          <div>All processing happens in your browser.</div>
        </div>
        <div>Powered by Tesseract.js ¬∑ No uploads ¬∑ No tracking</div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@7.0.0/dist/tesseract.min.js"></script>

    <script>
      /* ---------- STATE ---------- */
      let cancelRequested = false;
      let previewURLs = [];

      /* ---------- DOM ---------- */
      const imageInput = document.getElementById("imageInput");
      const previewList = document.getElementById("previewList");
      const extractBtn = document.getElementById("extractBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const spinner = document.getElementById("spinner");
      const statusText = document.getElementById("statusText");
      const resultText = document.getElementById("resultText");
      const progressBar = document.getElementById("progressBar");
      const progressWrap = progressBar.parentElement;

      const languageSel = document.getElementById("languageSelect");
      const presetSel = document.getElementById("presetSelect");
      const downscaleToggle = document.getElementById("downscaleToggle");
      const copyBtn = document.getElementById("copyBtn");
      const downloadBtn = document.getElementById("downloadBtn");

      const workerPath = "https://cdn.jsdelivr.net/npm/tesseract.js@7.0.0/dist/worker.min.js";
      const corePath = "https://cdn.jsdelivr.net/npm/tesseract.js-core@7.0.0/tesseract-core.wasm.js";
      const langPath = "https://tessdata.projectnaptha.com/4.0.0";

      const PRESET_STATUS = {
        scan: "Deskewing ‚Üí Enhancing contrast ‚Üí Recognizing text",
        screenshot: "Optimizing UI text ‚Üí Recognizing",
        notes: "Enhancing handwriting ‚Üí Recognizing",
        photo: "Normalizing photo ‚Üí Recognizing",
      };

      /* ---------- IMAGE DOWNSCALE ---------- */
      async function downscaleImage(file, maxWidth = 1600) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        if (img.naturalWidth <= maxWidth) {
          URL.revokeObjectURL(img.src);
          return file;
        }

        const scale = maxWidth / img.naturalWidth;
        const canvas = document.createElement("canvas");
        canvas.width = maxWidth;
        canvas.height = img.naturalHeight * scale;
        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

        URL.revokeObjectURL(img.src);
        return new Promise((res) => canvas.toBlob((b) => res(b), "image/jpeg", 0.9));
      }

      /* ---------- PREVIEW + MEMORY CLEANUP ---------- */
      imageInput.onchange = (e) => {
        previewURLs.forEach(URL.revokeObjectURL);
        previewURLs = [];
        previewList.innerHTML = "";

        [...e.target.files].forEach((f) => {
          const url = URL.createObjectURL(f);
          previewURLs.push(url);
          const img = document.createElement("img");
          img.src = url;
          img.className = "preview-thumb rounded";
          previewList.appendChild(img);
        });

        extractBtn.disabled = false;
      };

      /* ---------- OCR ---------- */
      extractBtn.onclick = async () => {
        const files = [...imageInput.files];
        if (!files.length) return;

        cancelRequested = false;
        extractBtn.disabled = true;
        cancelBtn.classList.remove("d-none");
        spinner.classList.remove("d-none");
        progressWrap.classList.remove("d-none");
        progressBar.style.width = "0%";
        statusText.setAttribute("aria-busy", "true");

        const startTime = Date.now();
        let output = "";
        const total = files.length;

        for (let i = 0; i < total; i++) {
          if (cancelRequested) break;

          const file = files[i];
          statusText.textContent = `${PRESET_STATUS[presetSel.value]} ¬∑ Image ${i + 1}/${total}`;

          let input = downscaleToggle.checked ? await downscaleImage(file) : file;

          const result = await Tesseract.recognize(input, languageSel.value, {
            workerPath,
            corePath,
            langPath,
            logger: (m) => {
              if (m.progress != null) {
                const overall = ((i + m.progress) / total) * 100;
                progressBar.style.width = `${Math.round(overall)}%`;

                const elapsed = (Date.now() - startTime) / 1000;
                const remaining = elapsed * ((100 - overall) / Math.max(overall, 1));
                statusText.textContent = `${PRESET_STATUS[presetSel.value]} ¬∑ Image ${i + 1}/${total} ¬∑ ~${Math.ceil(remaining)}s left`;
              }
            },
          });

          const text = result.data.text.trim();
          if (text) output += (output ? "\n\n---\n\n" : "") + text;
        }

        // Cleanup
        previewURLs.forEach(URL.revokeObjectURL);
        previewURLs = [];
        previewList.innerHTML = "";

        spinner.classList.add("d-none");
        progressWrap.classList.add("d-none");
        cancelBtn.classList.add("d-none");
        extractBtn.disabled = false;
        statusText.removeAttribute("aria-busy");

        if (cancelRequested) {
          statusText.textContent = "OCR cancelled.";
        } else {
          resultText.value = output || "No text detected.";
          copyBtn.disabled = !output;
          downloadBtn.disabled = !output;
          statusText.textContent = "OCR completed successfully.";
        }
      };

      /* ---------- CANCEL ---------- */
      cancelBtn.onclick = () => {
        cancelRequested = true;
      };

      /* ---------- SHORTCUTS ---------- */
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !extractBtn.disabled) extractBtn.click();
        if (e.key === "Escape") cancelBtn.click();
        if ((e.ctrlKey || e.metaKey) && e.key === "c") {
          navigator.clipboard.writeText(resultText.value);
        }
      });

      /* ---------- ACTIONS ---------- */
      copyBtn.onclick = async () => {
        await navigator.clipboard.writeText(resultText.value);
        statusText.textContent = "Copied!";
      };

      downloadBtn.onclick = () => {
        const blob = new Blob([resultText.value], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "ocr.txt";
        a.click();
      };
    </script>
  </body>
</html>
